---
title: "EM Environment Inventory (Prototype)"
author: "James D. Reed (jim.reed@prestigeservices.us)"
date: "May 19, 2018"
output: 
  html_document:
    df_print: paged
  word_document:
        reference_docx: headingthree.docx
        highlight: tango
        df_print: tibble
  pdf_document:
        includes:
          in_header: header.tex
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)

EMroot <- "data/agentExports"

source("C:/Users/jdree/Desktop/MyProjects/EM-Assessment/awsADS_functions.R")

knitr::opts_chunk$set(echo = FALSE)
```


# AWS Data Inventory

The purpose of this report is to provide a high-level summary of the records collected to date.

## Reports

The data collected from AWS consists of several types of data.  Here are the tables that have been collected:

**Included in this Report**

* results
* osInfo
* systemPerformance
* networkInterface
* destinationProcessConnection
* sourceProcessConnection
* process


### List Agent IDs in Current Data Store

The agent IDs are the unique identifiers of the AWS ADS agents installed within the customer's data center.  In the case of VMware hypervisor VMs, the agent ID is the identity of the OVA appliance installed. If additional performance metrics are required for a VM or the customer has a non-virtualized server, the agent ID is the identity of the actual agent installed on the server or VM.

Following are the Agent IDs found in the data store containing exported data from the AWS Migration Hub.  The Agent IDs will be used to identify which environment the data pertain to.

```{r}

agentIDs <- getAgentIDs(root = EMroot)
collected <-  tibble(
  Number   = seq(1:length(agentIDs)),
  AgentID = agentIDs
)

knitr::kable(collected)
```

There are `r length(agentIDs)` Agent IDs.  See the list of these immediately above.


### Number of Records Per Type by Agent ID


```{r Inv1, results = 'asis'}
resList <-   map(agentIDs, ~ getResults(EMroot,. ))
osList  <-   map(agentIDs, ~ getosInfo(EMroot,. ))
prList  <-   map(agentIDs, ~ getPerf(EMroot,. ))
nwList  <-   map(agentIDs, ~ getNetworkInterface(EMroot,. ))
dpList  <-   map(agentIDs, ~ getDestProcConn(EMroot,. ))
spList  <-   map(agentIDs, ~ getSrcProcConn(EMroot,. ))
pList   <-   map(agentIDs, ~ getProcess(EMroot,. ))



inventory <- tibble(
  Number           = seq(1:length(agentIDs)),
  AgentID          = agentIDs, 
  Results          = map_int(resList, ~ nrow(.)),
  OSInfo           = map_int(osList, ~ nrow(.)),
  Performance      = map_int(prList, ~ nrow(.)),
  NetworkInterface = map_int(nwList, ~ nrow(.)),
  DstProcessCon    = map_int(dpList, ~ nrow(.)),
  SrcProcessCon    = map_int(spList, ~ nrow(.)),
  Processes        = map_int(pList,  ~ nrow(.))
  )
  
knitr::kable(inventory, cap="AWS/ADS Records per Collection Type by Agent ID")

```

## Performance Time Spans by Agent ID

```{r Inv2, results = 'asis'}

prList  <-   map(agentIDs, ~ getPerf(EMroot,. ))
osList  <-   map(agentIDs, ~ getosInfo(EMroot,. ))




# Build comprehensive join of perfAll and osAll

perfAll <- bind_rows(prList) %>% select(1,2,19, 3:18) %>% arrange(agentId,timestamp)
osAll   <- bind_rows(osList) %>% select(1,2,8,6,3:5,7) %>% arrange(agentId, timestamp)


osValues <- osAll %>% 
  group_by(agentId) %>% 
  summarize( hostName =   unique(hostName),  osName  = unique(osName),   
             osVersion =  unique(osVersion), cpuType = unique(cpuType), 
             hypervisor = unique(hypervisor))

# This is the tibble to use for sizing and review - write this to an Exce3l file in tabs: Summary, host(1), host(2), ...
compInventory <- left_join(perfAll, osValues, by = "agentId") %>% select(1,2,20,3:19,21:24)
#######################################################################################################################


# Calculate the number of Days Performance for each server (hostName)

host_perf_time <- compInventory %>% 
  group_by(hostName) %>% 
  summarize(Max = ymd_hms(max(timestamp)), 
            Min = ymd_hms(min(timestamp)), 
            Diff.Days = difftime(Max, Min, units = "days"))
  
knitr::kable(host_perf_time, digits = 2, caption = "Performance Days by Hostname")


## TO-DO
#######################################################################################################################

#
# Build statistical summary table by hostName with these statistics:
#
#  Min and Max
#  Mean, Median
#  Std, 
#  95% Percentile

# Spreadsheet name:  <customer-prefix>-aws-performance.xlsx
#
# Tab     Name
#  1      Summary
#  2      hostName[1]
# ...     ...
#  N      hostName[last]
#

```


### Export Performance and OS Information Data to Excel Spreadsheet

```{r ExportData}
require(rJava)
require(xlsx)

# Create Nested file from compInventory

comp_n <- compInventory %>% 
  mutate(Host = hostName) %>%
  group_by(Host) %>% 
      nest()


# Create Excel Workbook with each hostName (agentId) on a separate tab.
fn <- "EM_performance.xlsx"

if (file.exists(fn)) file.remove(fn)  # to ensure we are writing a brand new file.
walk2(comp_n$data, comp_n$Host,~ write.xlsx(.x, file = fn, sheetName = .y, append = TRUE))

# List tabs in performance spreadsheet.  These should match the agentIds e wrote to the file.
file <- system.file("EM_performance.xlsx", fn, package = "xlsx")

wb <- loadWorkbook(fn)  
sheets <- getSheets(wb)


```

Spreadsheet created workbook **`r fn`** with **`r length(sheets)`** worksheets (tabs).

**Run Date: **`r Sys.Date()`